<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Employee Report — Glossy Dashboard</title>

<!-- ====== Styles (glossy + capsule tabs + animations) ====== -->
<style>
  :root {
  /* Background */
  --bg-0: #afd5fa; /* light gray */
  --bg-1: #adbef7; /* pale indigo tint */

  /* Panels / cards */
  --panel: #ffffffcc;
  --glass: rgba(255,255,255,0.7);
  --glass-border: rgba(0,0,0,0.08);

  /* Text */
  --muted: #475569; /* slate */
  --text: #0f172a; /* near-black */

  /* Accents */
  --accent-a: #06b6d4; /* cyan */
  --accent-b: #6366f1; /* indigo */
  --accent-c: #070113; /* amber */
  --accent-d: #ef4444; /* red */
  --accent-e: #22c55e; /* green */

  /* Layout */
  --card-radius: 16px;
  --pad: 16px;
  --maxw: 1300px;
}

html,body {
  height:auto;
  margin:0;
  background: linear-gradient(180deg,var(--bg-0),var(--bg-1));
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:rgb(0, 0, 0);
}
.wrap {
  max-width: var(--maxw);
  margin: 28px auto;
  padding: 28px;
  box-sizing: border-box;

  background: linear-gradient(180deg, #b3b2b1, #b2b3b2);
  border-radius: 16px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.1);
}


header {
  position: sticky;
  top: 0;
  z-index: 1000;

  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px 20px;

  background: linear-gradient(90deg, #636466, #282b2b);
  border-radius: 0 0 14px 14px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}


.brand {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo-circle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ff6f61, #d84315);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: 700;
  color: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.title-block h1 {
  font-size: 32px;
  font-weight: 800;
  margin: 0;
  color: #fff;
  line-height: 1.3;
}

.title-block h1 .highlight {
  display: block;
  font-weight: 700;
  font-size: 28px;
  color: #FFEB3B;
}

.subtitle {
  margin-top: 6px;
  font-size: 12px;
  color: rgba(255,255,255,0.85);
}


/* Capsule tabs */
.capsule-tabs {
  display:flex; gap:8px; position:relative; padding:6px;
  background: #020511;
  border-radius:32px; border:1px solid var(--glass-border);
}
.capsule-tabs .tab {
  padding:8px 16px; border-radius:30px; cursor:pointer; color:whitesmoke; font-weight:600;
  font-size:18px; white-space:nowrap; transition: all .22s cubic-bezier(.2,.9,.3,1);font-weight: bolder;
}
.capsule-tabs .tab:hover { transform: translateY(-3px) scale(1.02); color:rgb(26, 248, 5); }
.capsule-indicator {
  position:absolute; top:6px; left:6px; height:calc(100% - 12px); border-radius:30px;
  background: linear-gradient(90deg, #5802022f, rgba(41, 1, 3, 0.562));
  box-shadow: 0 8px 20px rgba(6,182,212,0.15);
  transition: transform .28s cubic-bezier(.2,.9,.3,1), width .28s cubic-bezier(.2,.9,.3,1);
  color:whitesmoke;
}
.capsule-tabs .tab.active {
    background-color: #20cb75;   /* Red background */
    color: rgb(5, 0, 0);            /* White text */
    transform: translateY(-2px) scale(1.03); /* Optional: slightly lifted effect */
}

/* subtabs capsule */
.capsule-sub { display:flex; gap:8px; margin: 18px 0 6px 0; align-items:center; }
.capsule-sub .tab {
  padding:7px 12px; font-size:16px; border-radius:20px; background:#020511; border:1px solid #ddd; color:rgb(235, 234, 240);font-weight: bolder;
}
.capsule-sub .tab:hover { transform: translateY(-3px) scale(1.02); color:rgb(26, 248, 5); }
.capsule-sub .tab.active {
  background: linear-gradient(90deg, #20cb75, #20cb75);
  color:rgb(19, 1, 1); border-color: transparent;
}

main { margin-top: 8px; display:grid; grid-template-columns: 1fr; gap:18px; }

/* Widgets row */
.widgets { display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; }
.widget {
  border-radius:var(--card-radius); padding:16px;
  border: 1px solid var(--glass-border);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  min-height:96px; position:relative; overflow:hidden;
  transition: transform .18s ease, box-shadow .18s ease;
}
.widget:nth-child(1) { background: linear-gradient(135deg, #111827, #1e293b); color:#fff; }
.widget:nth-child(2) { background: linear-gradient(135deg,  #111827, #1e293b); color:#fff; }
.widget:nth-child(3) { background: linear-gradient(135deg, #111827, #1e293b); color:#fff; }
.widget:nth-child(4) { background: linear-gradient(135deg, #111827, #1e293b); color:#fff; }
.widget:nth-child(5) { background: linear-gradient(135deg, #111827, #1e293b); color:#fff; }
.widget:nth-child(6) { background: linear-gradient(135deg, #111827, #1e293b); color:#fff; }
.widget:nth-child(7) { background: linear-gradient(135deg, #111827, #1e293b); color:#fff; }
.widget:nth-child(8) { background: linear-gradient(135deg, #111827, #1e293b); color:#fff; }

.widget:hover { transform: translateY(-6px); box-shadow: 0 12px 28px rgba(0,0,0,0.25); }
.widget .title { color:#e2e8f0; font-size:13px; margin-bottom:6px; font-weight:700; }
.widget .value { font-size:22px; font-weight:800; color:#deec0f; display:flex; gap:10px; align-items:center; }
.widget .value i { font-size:20px; background:linear-gradient(135deg,var(--accent-c),var(--accent-e)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.widget .sub { color:#07df4f; font-size:12px; margin-top:6px; }

/* circular progress mini */
.ring {
  width:44px; height:44px; display:inline-block; border-radius:50%;
  background:rgba(255,255,255,0.2);
  padding:6px; box-sizing:border-box;
}

/* processed / pending chips */
/* Base chip */
.chip {
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  color: #fff; /* ensure contrast */
}

.chip small {
  font-size: 12px;
  opacity: 0.8;
}
.chip strong {
  font-size: 16px;
  font-weight: 700;
}

/* Bar */
.chip-bar {
  height: 6px;
  width: 100%;
  background: rgba(255,255,255,0.15);
  border-radius: 6px;
  overflow: hidden;
}
.chip-bar-fill {
  height: 100%;
  transition: width .4s ease;
  border-radius: 6px;
}

/* ✅ Processed buckets */

.chip.p1    { background: rgba(58, 150, 96, 0.897); border-left: 8px solid #032411; }
.chip-bar-fill.p1   { background: #072e17; }
.chip.p2    { background: rgba(58, 150, 96, 0.897); border-left: 8px solid #032411; }
.chip-bar-fill.p2   { background: #072e17; }
.chip.p3    { background: rgba(58, 150, 96, 0.897); border-left: 8px solid #032411; }
.chip-bar-fill.p3   { background: #072e17; }
.chip.p1w    { background: rgba(58, 150, 96, 0.897); border-left: 8px solid #032411; }
.chip-bar-fill.p1w  { background: #072e17; }
.chip.p1m    { background: rgba(58, 150, 96, 0.897); border-left: 8px solid #032411; }
.chip-bar-fill.p1m   { background: #072e17; }
.chip.pgt1m    { background: rgba(58, 150, 96, 0.897); border-left: 8px solid #032411; }
.chip-bar-fill.pgt1m   { background: #072e17; }

/* ✅ Pending buckets */
.chip.pending_lt7   { background: rgba(151, 31, 37, 0.911); border-left: 8px solid #2e0305; }
.chip-bar-fill.pending_lt7   { background: #2e0305; }

.chip.pending_ge7   { background: rgba(151, 31, 37, 0.911); border-left: 8px solid #2e0305; }
.chip-bar-fill.pending_ge7   { background: #2e0305; }

.chip.pending_ge15  { background: rgba(151, 31, 37, 0.911); border-left: 8px solid #2e0305; }
.chip-bar-fill.pending_ge15  { background: #2e0305; }

.chip.pending_ge30  { background: rgba(151, 31, 37, 0.911); border-left: 8px solid #2e0305; }
.chip-bar-fill.pending_ge30  { background: #2e0305; }

.chip.pending_ge60  { background: rgba(151, 31, 37, 0.911); border-left: 8px solid #2e0305; }
.chip-bar-fill.pending_ge60  { background: #2e0305; }

.chip.pending_ge90  { background: rgba(151, 31, 37, 0.911); border-left: 8px solid #2e0305; }
.chip-bar-fill.pending_ge90  { background: #2e0305; }

.chip.pending_ge120 { background: rgba(151, 31, 37, 0.911); border-left: 8px solid #2e0305; }
.chip-bar-fill.pending_ge120 { background: #2e0305; }
/* Chip container (processedChips & pendingChips) */
#processedChips, #pendingChips {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
/* Heartbeat animation */
@keyframes heartbeat {
  0%   { transform: scale(1); }
  25%  { transform: scale(1.15); }
  40%  { transform: scale(0.95); }
  60%  { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.heartbeat strong {
  animation: heartbeat 1.5s infinite;
  display: inline-block;
}

/* For small screens → stack nicely */
@media (max-width: 900px) {
  #processedChips, #pendingChips {
    grid-template-columns: repeat(2, 1fr);
  }
}
@media (max-width: 500px) {
  #processedChips, #pendingChips {
    grid-template-columns: 1fr;
  }
}

/* ================================
   Table Card & Controls
=================================== */
.table-card {
  border-radius: 16px;
  padding: 16px;
  background: #ffffff;
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 8px 24px rgba(0,0,0,0.06);
  overflow-x: auto;
}

.table-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  gap: 10px;
}

.search {
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ddd;
  background: #fafafa;
  color: #333;
  width: 280px;
  transition: all 0.2s ease;
}
.search:focus {
  outline: none;
  border-color: #111827;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(74,85,233,0.2);
}

#pageSize {
  border-radius: 20px;
  padding: 8px 14px;
  border: 1px solid #ddd;
  background: #fafafa;
  font-weight: 500;
}

/* ================================
   Table Wrapper
=================================== */
.table-wrap {
  max-height: 500px;
  overflow-y: auto;
  border-radius: 12px;
  border: 1px solid #eee;
}

/* ================================
   Table
=================================== */
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1600px;
  font-size: 13px;
}

thead th {
  position: sticky;
  top: 0;
  z-index: 20;               /* always above body cells */
  background: #111827;
  color: #f7f1bd;
  padding: 12px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  border-bottom: 2px solid #e5e7eb;
  letter-spacing: 0.3px;
}

tbody tr {
  border-bottom: 1px solid #f1f1f1;
  transition: all 0.15s ease;
}
tbody tr:nth-child(even) {
  background: #fafafa;
}
tbody tr:hover {
  background: #fef9c3;
  transform: scale(1.01);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  z-index: 5;
}

td {
  padding: 10px 12px;
  color: #333;
  text-align: center;
  white-space: nowrap;
}

/* ================================
   Sticky Columns
=================================== */
/* Sticky first column (header + body) */
table th:first-child,
table td:first-child {
  position: sticky;
  left: 0;
  width: 250px;
  background: #111827;
  color: #f7f1bd;
  text-align: left;
  box-shadow: 2px 0 6px rgba(0,0,0,0.05);
}

/* Make sure header cell of col1 is above its body cells */
table th:first-child {
  z-index: 30;    /* higher than td:first-child */
}
table td:first-child {
  z-index: 10;
}

/* Sticky second column (header + body) */
table th:nth-child(2),
table td:nth-child(2) {
  position: sticky;
  left: 45px; /* must equal first col width */
  width: 150px;
  background: #111827;
  color: #f7f1bd;
  text-align: center;
  box-shadow: 2px 0 6px rgba(0,0,0,0.05);
}

/* Ensure header of col2 stays above body */
table th:nth-child(2) {
  z-index: 25;    /* above body but below col1 header */
}
table td:nth-child(2) {
  z-index: 15;
}
/* ================================
   Column Coloring
=================================== */
table tbody td:nth-child(2) {
  font-weight: 700;
}

table tbody td:nth-child(3) {
  color: #bd0505;
  font-weight: 700;
  background: #c9ecf7;
}
table tbody td:nth-child(4) {
  color: #1a0101;
  font-weight: 700;
  background: #c9ecf7;
}
table tbody td:nth-child(n+5):nth-child(-n+10) {
  color: #0a0101;
  font-weight: 700;
  background: #f5f7a5a4;
}
table tbody td:nth-child(n+11):nth-child(-n+16) {
  color: #1a0101;
  font-weight: 700;
  background: #a5fac191;
}
table tbody td:nth-child(n+17):nth-child(-n+23) {
  color: #1a0101;
  font-weight: 700;
  background: #f3cda285;
}

/* ================================
   Sorting & Pagination
=================================== */
.sort-ind {
  margin-left: 6px;
  font-size: 11px;
  opacity: 0.8;
}

.pager {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-top: 14px;
  justify-content: flex-end;
}

.page-btn {
  padding: 6px 12px;
  border-radius: 20px;
  background: #f9fafb;
  border: 1px solid #ddd;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s ease;
}
.page-btn:hover {
  background: #eef2ff;
  border-color: #111827;
  color: #111827;
}
.page-btn.active {
  background: #111827;
  color: #fff;
  border-color: #111827;
}

/* small screens */
@media (max-width:1000px){
  .widgets { grid-template-columns: repeat(2,1fr); }
  .capsule-tabs { overflow:auto; }
}
@media (max-width:700px){
  .widgets { grid-template-columns: 1fr; }
  .search { width:160px; }
}

/* animations */
@keyframes popIn {
  from { opacity:0; transform:translateY(8px) scale(.98); }
  to { opacity:1; transform:none; }
}
.animate-pop { animation: popIn .36s cubic-bezier(.2,.9,.3,1) both; }
#tryLoadBtn,
#resetBtn {
  display: none;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="wrap">
  <header>
  <div class="brand">
    <div class="logo-circle">CMO</div>
    <div class="title-block">
      <h1>Chief Minister’s Office Andhra Pradesh<span class="highlight">e-Office KPIs Dashboard</span></h1>
      <div class="subtitle">📊 Data as on <strong>1st Sep 2025</strong></div>
    </div>
  </div>
</header>


  <!-- Tabs (capsule) -->
  <div id="periodRow" style="margin-bottom:18px">
    <div class="capsule-tabs" id="capsuleTabs" role="tablist" aria-label="Periods">
      <div class="capsule-indicator" id="capsuleIndicator" style="width:0px;"></div>
      <!-- tabs injected here -->
    </div>
    <div class="capsule-sub" id="subTabsContainer"></div>
  </div>

  <main>
    <!-- Top widgets -->
    <div class="widgets animate-pop" id="widgetsContainer" aria-live="polite"></div>

    <!-- Processed & Pending -->
    <section style="display:flex; gap:16px; flex-wrap:wrap">
      <div style="flex:1; min-width:300px">
        <div style="font-size: 30px; font-weight:700;margin-bottom:8px;color:rgb(0, 2, 0)">Processed Time Buckets</div>
        <div class="chips" id="processedChips"></div>
      </div>

      <div style="flex:1; min-width:300px">
        <div style="font-size: 30px;font-weight:700;margin-bottom:8px;color:rgb(0, 2, 0)">Pending Age Buckets</div>
        <div class="chips" id="pendingChips"></div>
      </div>
    </section>

    <!-- Table -->
    <div class="table-card animate-pop">
      <div class="table-controls">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="searchInput" class="search" placeholder="Search employee..." />
          <select id="pageSize" class="btn" style="border-radius:8px;padding:8px 10px;">
            
            <option value="25">25 / page</option>
            <option value="50">50 / page</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:center;font-size: large; font-weight: 900; color:var(--muted)">
          <div id="tableInfo">0 employees</div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="empTable" role="table">
          <thead>
            <tr>
              <th style="width:60px; text-align:center;">S. No.</th>
              <th data-key="Employee">Employee <span class="sort-ind">↕</span></th>
              <th data-key="Avg Time (mins)">Avg Time for a File<span class="sort-ind">↕</span></th>
              <th data-key="Median Time (mins)">Median for a File (mins)<span class="sort-ind">↕</span></th>
              <th data-key="Opening Balance">Opening Balance<span class="sort-ind">↕</span></th>
              <th data-key="Received Files">Received Files<span class="sort-ind">↕</span></th>
              <th data-key="Processed Files">Processed Files<span class="sort-ind">↕</span></th>
              <th data-key="Closed Files">Closed Files<span class="sort-ind">↕</span></th>
              <th data-key="Pending Files">Pending Files<span class="sort-ind">↕</span></th>
              <th data-key="Parked Files">Parked Files<span class="sort-ind">↕</span></th>
              <th data-key="Processed ≤1d">Processed ≤1 D <span class="sort-ind">↕</span></th>
              <th data-key="Processed ≤2d">Processed ≤2 D <span class="sort-ind">↕</span></th>
              <th data-key="Processed ≤3d">Processed ≤3 D <span class="sort-ind">↕</span></th>
              <th data-key="Processed ≤1d">Processed ≤7 D <span class="sort-ind">↕</span></th>
              <th data-key="Processed ≤1W">Processed ≤30 D <span class="sort-ind">↕</span></th>
              <th data-key="Processed ≤1M">Processed >30 D <span class="sort-ind">↕</span></th>
              <th data-key="Pending <7Days">Pending <7 D <span class="sort-ind">↕</span></th>
              <th data-key="Pending ≥7Days">Pending ≥7 D <span class="sort-ind">↕</span></th>
              <th data-key="Pending ≥15Days">Pending ≥15 D <span class="sort-ind">↕</span></th>
              <th data-key="Pending ≥30Days">Pending ≥30 D <span class="sort-ind">↕</span></th>
              <th data-key="Pending ≥60Days">Pending ≥60 D <span class="sort-ind">↕</span></th>
              <th data-key="Pending ≥90Days">Pending ≥90 D <span class="sort-ind">↕</span></th>
              <th data-key="Pending ≥120Days">Pending ≥120 D <span class="sort-ind">↕</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pager" id="pager"></div>
    </div>
    
  </main>
</div>



<!-- ====== Script ====== -->
<script>
/* ----------------------------
  Glossy Dashboard — main script
  - auto-load employee_report.json if present
  - or accept uploaded JSON file
  - capsule tabs, widgets, chips and table
-----------------------------*/

const tryLoadBtn = document.getElementById('tryLoadBtn');
const resetBtn = document.getElementById('resetBtn');
const capsuleTabs = document.getElementById('capsuleTabs');
const capsuleIndicator = document.getElementById('capsuleIndicator');
const subTabsContainer = document.getElementById('subTabsContainer');
const widgetsContainer = document.getElementById('widgetsContainer');
const processedChips = document.getElementById('processedChips');
const pendingChips = document.getElementById('pendingChips');
const tableBody = document.querySelector('#empTable tbody');
const tableInfo = document.getElementById('tableInfo');
const searchInput = document.getElementById('searchInput');
const pageSizeSelect = document.getElementById('pageSize');
const pager = document.getElementById('pager');

let rawData = [];
let normalized = [];
let periods = [];
let activePeriod = null;
let offices = [];
let activeOffice = null;
let visibleRows = [];
let sortState = { key: 'Avg Time (mins)', dir: 'asc' };
let page = 1;

/* helper to safely read various key name variants */
function pick(row, keys){
  for(const k of keys){
    if(k in row && row[k] !== null && row[k] !== undefined && String(row[k]).trim() !== '') return row[k];
  }
  return null;
}

const mapKeys = {
  period: ['Period','period'],
  employee: ['Employee','employee','holder'],
  office: ['Office_Type','office_type','Office Type','OfficeType'],
  cadre: ['Cadre_Type','cadre_type','Cadre Type','CadreType'],
  opening: ['Opening Balance','Opening','Opening_Balance'],
  received: ['Received Files','Received','Received_Files'],
  processed: ['Processed Files','Processed','Processed_Files'],
  closed: ['Closed Files','Closed','Closed_Files'],
  pending: ['Pending Files','Pending','Pending_Files'],
  parked: ['Parked Files','Parked','Parked_Files'],
  avg: ['Avg Time (mins)','Avg Time','AvgTime'],
  median: ['Median Time (mins)','MedianTime']
};

/* bucket keys */
const bucketKeys = {
  p1: ['Processed ≤1d','Processed <=1d','Processed <= 1d','Processed <= 1 day'],
  p2: ['Processed ≤2d','Processed <=2d'],
  p3: ['Processed ≤3d'],
  p1w:['Processed ≤1w'],
  p1m:['Processed ≤1m'],
  pgt1m:['Processed >1m'],
  pending_lt7:['Pending <7Days','Pending < 7Days'],
  pending_ge7:['Pending ≥7Days','Pending >=7Days','Pending >= 7Days'],
  pending_ge15:['Pending ≥15Days'],
  pending_ge30:['Pending ≥30Days'],
  pending_ge60:['Pending ≥60Days'],
  pending_ge90:['Pending ≥90Days'],
  pending_ge120:['Pending ≥120Days']
};

/* normalize rows */
function normalizeRows(rows){
  return rows.map(r=>{
    const out = Object.assign({}, r);
    out._period = pick(r, mapKeys.period) || 'Unknown';
    out._employee = pick(r, mapKeys.employee) || 'Unknown';
    out._office = pick(r, mapKeys.office) || 'Unknown';
    out._cadre = pick(r, mapKeys.cadre) || '';
    out._opening = Number(pick(r, mapKeys.opening)) || 0;
    out._received = Number(pick(r, mapKeys.received)) || 0;
    out._processed = Number(pick(r, mapKeys.processed)) || 0;
    out._closed = Number(pick(r, mapKeys.closed)) || 0;
    out._pending = Number(pick(r, mapKeys.pending)) || 0;
    out._parked = Number(pick(r, mapKeys.parked)) || 0;
    out._avg = Number(pick(r, mapKeys.avg));
    out._median = Number(pick(r, mapKeys.median));

    out._b = {};
    for(const k in bucketKeys){
      out._b[k] = Number(pick(r, bucketKeys[k])) || 0;
    }
    return out;
  });
}

function formatMinutes(mins) {
  if (mins == null || isNaN(mins) || mins <= 0) return '-';
  const days = Math.floor(mins / (60*24));
  const hours = Math.floor((mins % (60*24)) / 60);
  const minutes = Math.round(mins % 60);
  return `${days} D ${hours} H ${minutes} M`;
}


/* main loader */
function loadData(rows){
  rawData = rows;
  normalized = normalizeRows(rows);
  periods = Array.from(new Set(normalized.map(r=>r._period)));
  if(periods.length===0) periods = ['Entire Period'];
  activePeriod = periods[0];
  renderPeriodCapsule();
  computeOffices();
  renderSubTabs();
  setActivePeriod(activePeriod);
}

/* capsule tabs */
function renderPeriodCapsule(){
  capsuleTabs.querySelectorAll('.tab').forEach(n=>n.remove());
  periods.forEach((p)=>{
    const el = document.createElement('div');
    el.className = 'tab';
    el.setAttribute('role','tab');
    el.textContent = p;
    el.onclick = ()=> setActivePeriod(p);
    capsuleTabs.appendChild(el);
  });
  requestAnimationFrame(()=> updateIndicatorToActive() );
}

function setActivePeriod(p){
  activePeriod = p;
  [...capsuleTabs.querySelectorAll('.tab')].forEach(t=> t.classList.toggle('active', t.textContent===p));
  updateIndicatorToActive();
  computeOffices();
  renderSubTabs();
  setActiveOffice(offices[0] || null);
  
}

function updateIndicatorToActive(){
  const tabs = [...capsuleTabs.querySelectorAll('.tab')];
  const active = tabs.find(t=>t.classList.contains('active'));
  if(!active){ capsuleIndicator.style.width = '0px'; return; }
  const left = active.offsetLeft - 6;
  const width = active.offsetWidth;
  capsuleIndicator.style.transform = `translateX(${left}px)`;
  capsuleIndicator.style.width = width + 'px';
}

/* offices */
function computeOffices(){
  offices = Array.from(new Set(normalized.filter(r=>r._period===activePeriod).map(r=>r._office))).sort();
}

function renderSubTabs(){
  subTabsContainer.innerHTML = '';
  if(!offices.length){ subTabsContainer.innerHTML = '<div class="small" style="color:var(--muted)">No offices</div>'; return; }
  offices.forEach((o, idx)=>{
    const b = document.createElement('div');
    b.className = 'tab' + (idx===0?' active':'');
    b.textContent = o;
    b.onclick = ()=> setActiveOffice(o);
    subTabsContainer.appendChild(b);
  });
}

function setActiveOffice(o){
  activeOffice = o;
  [...subTabsContainer.querySelectorAll('.tab')].forEach(t=> t.classList.toggle('active', t.textContent===o));
  renderActiveView();
}

function rowsForActive(){
  return normalized.filter(r => r._period === activePeriod && (activeOffice ? r._office === activeOffice : true));
}

/* render active view */
function renderActiveView(){
  const rows = rowsForActive();
  visibleRows = rows;
  renderWidgets(rows);
  renderBuckets(rows);
  renderTable(rows);
  updateTableInfo();
}

/* animate number */
function animateNumber(el, to, opts = {}) {
  const duration = opts.duration || 750;
  const from = Number(el.dataset.from) || 0;
  const formatter = opts.formatter || (v => String(v).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
  el.dataset.from = to;
  const start = performance.now();
  
  function step(now){
    const t = Math.min(1, (now - start)/duration);
    const v = from + (to - from) * easeOutCubic(t);
    el.textContent = formatter(Math.round(v));
    if(t < 1) requestAnimationFrame(step);
  }
  
  requestAnimationFrame(step);
}

function easeOutCubic(t){ return (--t)*t*t+1; }

/* sparkline */
function makeSparklineSVG(rowset){
  const keys = ['p1','p2','p3','p1w','p1m','pgt1m'];
  const vals = keys.map(k => rowset.reduce((s,r)=> s + (r._b[k]||0), 0));
  const max = Math.max(...vals,1);
  const w = 120, h = 34, pad = 4;
  const step = (w - pad*2) / (vals.length - 1);
  const points = vals.map((v,i)=> `${pad + i*step},${h - pad - (v/max)*(h - pad*2)}`);
  const path = 'M' + points.join(' L ') + ` L ${w-pad},${h-pad} L ${pad},${h-pad} Z`;
  const poly = `<polyline points="${points.join(' ')}" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>`;
  const area = `<path d="${path}" fill="rgba(7,199,216,0.06)"></path>`;
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">${area}${poly}</svg>`;
}

/* widgets */
function renderWidgets(rows){
  widgetsContainer.innerHTML = '';
  const opening = rows.reduce((s,r)=> s + r._opening,0);
  const received = rows.reduce((s,r)=> s + r._received,0);
  const processed = rows.reduce((s,r)=> s + r._processed,0);
  const closed = rows.reduce((s,r)=> s + r._closed,0);
  const pending = rows.reduce((s,r)=> s + r._pending,0);
  const parked = rows.reduce((s,r)=> s + r._parked,0);
  const avg = meanWeighted(rows, r => r._avg, r => r._processed);
  const median = medianOf(rows.map(r => r._median).filter(v=>!isNaN(v)));

  const items = [
    {title:'Opening Balance', value: opening, icon: svgOpeningBalance()},
    {title:'Files Received', value: received, icon: svgReceivedFiles()},
    {title:'Files Processed', value: processed, icon: svgProcessedFiles()},
    {title:'Files Closed', value: closed, icon: svgFilesClosed()},
    {title:'Files Pending', value: pending, icon: svgFilesPending()},
    {title:'Files Parked', value: parked, icon: svgFilesParked()},
    {title:'Avg Processing Time', value: avg, formatter: formatMinutes, icon: svgAvgProcessingTime()},
    {title:'Median Processing Time', value: median, formatter: formatMinutes, icon: svgMedianProcessingTime()},
  ];

  items.forEach(it=>{
    const w = document.createElement('div');
    w.className = 'widget';
    const displayValue = it.formatter ? it.formatter(it.value) : it.value;
    w.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="title">${it.title}</div>
          <div class="value"><span class="num" data-from="0">${displayValue}</span></div>
          <div class="sub">for ${activeOffice || 'All Offices'} · ${activePeriod}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="ring" style="background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.01));">
            ${it.icon}
          </div>
          <div style="opacity:.85;font-size:12px;color:var(--muted)">${makeSparklineSVG(rows)}</div>
        </div>
      </div>`;

    widgetsContainer.appendChild(w);
    const numEl = w.querySelector('.num');

    // Animate only if there is no formatter (skip Avg & Median)
    if(!it.formatter){
      animateNumber(numEl, (typeof it.value === 'number') ? it.value : (isNaN(Number(it.value))?0:Number(it.value)));
    }
  });
}


/* mean weighted & median */
function meanWeighted(rows, valFn, weightFn){
  let num=0, den=0;
  rows.forEach(r=>{ const v=valFn(r); const w=weightFn(r); if(!isNaN(v)&&!isNaN(w)&&w>0){num+=v*w; den+=w;} });
  if(den>0) return num/den;
  const vs = rows.map(r=>valFn(r)).filter(v=>!isNaN(v));
  if(!vs.length) return null;
  return vs.reduce((a,b)=>a+b,0)/vs.length;
}
function medianOf(arr){ if(!arr.length) return null; arr = arr.slice().sort((a,b)=>a-b); const m=Math.floor(arr.length/2); return arr.length%2?arr[m]:(arr[m-1]+arr[m])/2; }

/* processed/pending chips */
/* processed/pending chips */
function renderBuckets(rows) {
  processedChips.innerHTML = '';
  const pKeys = ['p1','p2','p3','p1w','p1m','pgt1m'];
  const pLabels = ['Processed ≤1D','Processed ≤2D','Processed ≤3D','Processed ≤1W','Processed ≤1M','Processed >1M'];
  const pVals = pKeys.map(k => rows.reduce((s,r)=> s + (r._b[k]||0),0));
  const maxPVal = Math.max(1, ...pVals);

  pKeys.forEach((k,i)=>{
  const c = document.createElement('div');
  c.className = `chip chip-processed ${k}`;
  const percent = Math.min(100, Math.round((pVals[i] / maxPVal) * 100));
  c.innerHTML = `
    <small>${pLabels[i]}</small>
    <strong>${pVals[i]}</strong>
    <div class="chip-bar">
      <div class="chip-bar-fill ${k}" style="width:${percent}%"></div>
    </div>`;
  processedChips.appendChild(c);
  if (k === 'pgt1m' ) {
  c.classList.add('heartbeat');
}
});

  pendingChips.innerHTML = '';
  const pendKeys = ['pending_ge7','pending_ge15','pending_ge30','pending_ge60','pending_ge90','pending_ge120'];
  const pendLabels = ['Pending ≥7D','Pending ≥15D','Pending ≥30D','Pending ≥60D','Pending ≥90D','Pending ≥120D'];
  const pendVals = pendKeys.map(k => rows.reduce((s,r)=> s + (r._b[k]||0),0));
  const maxPendVal = Math.max(1, ...pendVals);

  pendKeys.forEach((k,i)=>{
  const c = document.createElement('div');
  c.className = `chip chip-pending ${k}`;
  const percent = Math.min(100, Math.round((pendVals[i] / maxPendVal) * 100));
  c.innerHTML = `
    <small>${pendLabels[i]}</small>
    <strong>${pendVals[i]}</strong>
    <div class="chip-bar">
      <div class="chip-bar-fill ${k}" style="width:${percent}%"></div>
    </div>`;
  pendingChips.appendChild(c);
  // Example: make pending >= 30D flash
if (k === 'pending_ge90' || k === 'pending_ge120') {
  c.classList.add('heartbeat');
}

});
}


/* table rendering */
const columns = [
  'Employee','Avg Time for a file','Median Time for a FIle','Opening Balance','Received Files','Processed Files','Closed Files','Pending Files','Parked Files',
  'Processed ≤1d','Processed ≤2d','Processed ≤3d','Processed ≤1W','Processed ≤1M','Processed >1M',
  'Pending <7Days','Pending ≥7Days','Pending ≥15Days','Pending ≥30Days','Pending ≥60Days','Pending ≥90Days','Pending ≥120Days'
];

function renderTable(rows){
  const q = (searchInput.value || '').trim().toLowerCase();
  let filtered = rows.filter(r=> !q || (r._employee && r._employee.toLowerCase().includes(q)));
  
  // Sorting
  if(sortState.key){
    const key = sortState.key;
    filtered.sort((a,b)=>{
      const av = valForKey(a,key), bv = valForKey(b,key);
      if(av===bv) return 0;
      return sortState.dir==='asc'? (av>bv?1:-1):(av<bv?1:-1);
    });
  }

  const pageSize = Number(pageSizeSelect.value);
  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  if(page>totalPages) page=totalPages;
  const start = (page-1)*pageSize;
  const pageRows = filtered.slice(start,start+pageSize);

  tableBody.innerHTML='';
  pageRows.forEach((r, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center;font-weight:600;color: #f7f1bd;">${start + i + 1}</td>
      <td class="col-emp">${escapeHtml(r._employee)}</td>
      <td>${formatMinutes(r._avg)}</td>
      <td>${formatMinutes(r._median)}</td>
      <td>${r._opening}</td>
      <td>${r._received}</td>
      <td>${r._processed}</td>
      <td>${r._closed}</td>
      <td>${r._pending}</td>
      <td>${r._parked}</td>
      <td>${r._b.p1}</td>
      <td>${r._b.p2}</td>
      <td>${r._b.p3}</td>
      <td>${r._b.p1w}</td>
      <td>${r._b.p1m}</td>
      <td>${r._b.pgt1m}</td>
      <td>${r._b.pending_lt7}</td>
      <td>${r._b.pending_ge7}</td>
      <td>${r._b.pending_ge15}</td>
      <td>${r._b.pending_ge30}</td>
      <td>${r._b.pending_ge60}</td>
      <td>${r._b.pending_ge90}</td>
      <td>${r._b.pending_ge120}</td>`;
    tableBody.appendChild(tr);
  });

  renderPager(filtered.length,pageSize,page);
  tableInfo.textContent = `${filtered.length} employees (${pageRows.length} shown)`;
}


function valForKey(row,key){
  switch(key){
    case 'Employee': return row._employee || '';
    case 'Office_Type': return row._office || '';
    case 'Cadre_Type': return row._cadre || '';
    case 'Avg Time (mins)': return isNaN(row._avg)?-1:row._avg;
    case 'Median Time (mins)': return isNaN(row._median)?-1:row._median;
    case 'Opening Balance': return row._opening;
    case 'Received Files': return row._received;
    case 'Processed Files': return row._processed;
    case 'Closed Files': return row._closed;
    case 'Pending Files': return row._pending;
    case 'Parked Files': return row._parked;
    case 'Processed ≤1d': return row._b.p1;
    case 'Processed ≤2d': return row._b.p2;
    case 'Processed ≤3d': return row._b.p3;
    case 'Processed ≤1w': return row._b.p1w;
    case 'Processed ≤1m': return row._b.p1m;
    case 'Processed >1m': return row._b.pgt1m;
    case 'Pending <7Days': return row._b.pending_lt7;
    case 'Pending ≥7Days': return row._b.pending_ge7;
    case 'Pending ≥15Days': return row._b.pending_ge15;
    case 'Pending ≥30Days': return row._b.pending_ge30;
    case 'Pending ≥60Days': return row._b.pending_ge60;
    case 'Pending ≥90Days': return row._b.pending_ge90;
    case 'Pending ≥120Days': return row._b.pending_ge120;
    default: return '';
  }
}

/* pagination */
function renderPager(totalCount,pageSize,currentPage){
  pager.innerHTML='';
  const totalPages = Math.max(1, Math.ceil(totalCount/pageSize));
  const left = document.createElement('button'); left.className='page-btn'; left.textContent='‹'; left.disabled=currentPage===1;
  left.onclick = ()=>{if(currentPage>1){page--;renderActiveView();}};
  pager.appendChild(left);

  const start = Math.max(1,currentPage-3);
  const end = Math.min(totalPages,start+6);
  for(let p=start;p<=end;p++){
    const btn = document.createElement('button');
    btn.className='page-btn'+(p===currentPage?' active':'');
    btn.textContent=p;
    btn.onclick=()=>{page=p; renderActiveView();};
    pager.appendChild(btn);
  }

  const right = document.createElement('button'); right.className='page-btn'; right.textContent='›'; right.disabled=currentPage===totalPages;
  right.onclick = ()=>{if(currentPage<totalPages){page++;renderActiveView();}};
  pager.appendChild(right);
}

/* table header sorting */
document.querySelectorAll('#empTable thead th').forEach(th=>{
  th.style.cursor='pointer';
  th.addEventListener('click',()=>{
    const key=th.dataset.key;
    if(sortState.key===key) sortState.dir = sortState.dir==='asc'?'desc':'asc';
    else { sortState.key=key; sortState.dir='asc'; }
    document.querySelectorAll('#empTable thead th .sort-ind').forEach(el=>el.textContent='↕');
    th.querySelector('.sort-ind').textContent = sortState.dir==='asc'?'▲':'▼';
    renderActiveView();
  });
});

searchInput.addEventListener('input',()=>{page=1;renderActiveView();});
pageSizeSelect.addEventListener('change',()=>{page=1;renderActiveView();});


/* helpers */
function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toNumber(x){return isNaN(Number(x))?0:Number(x);}

/* SVG icons */
/* Inbox – bluish theme */
function svgInbox() {
  return `<svg width="28" height="28" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradInbox" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
        <stop stop-color="#4FC3F7"/>
        <stop offset="1" stop-color="#0288D1"/>
      </linearGradient>
    </defs>
    <path d="M4 7h5l2 3h2l2-3h5v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z"
          stroke="url(#gradInbox)" stroke-width="1.6"
          stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
}

/* Folder – amber theme */
/* Opening Balance – Inbox */
function svgOpeningBalance() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradOpening" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#42A5F5"/>
        <stop offset="1" stop-color="#1565C0"/>
      </linearGradient>
      <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="1.5" stdDeviation="1.5" flood-color="rgba(0,0,0,0.35)"/>
      </filter>
    </defs>
    <path d="M4 7h5l2 3h2l2-3h5v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z"
          stroke="url(#gradOpening)" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round"
          filter="url(#shadow)"/>
  </svg>`;
}

/* Received Files – Arrow Down */
function svgReceivedFiles() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradReceived" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#29B6F6"/>
        <stop offset="1" stop-color="#0277BD"/>
      </linearGradient>
    </defs>
    <path d="M12 3v14m0 0l-5-5m5 5l5-5"
          stroke="url(#gradReceived)" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round"
          filter="url(#shadow)"/>
  </svg>`;
}

/* Processed Files – Lightning */
function svgProcessedFiles() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradProcessed" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#FFB74D"/>
        <stop offset="1" stop-color="#E65100"/>
      </linearGradient>
    </defs>
    <path d="M13 2L3 14h7l-1 8L21 10h-7l-1-8z"
          stroke="url(#gradProcessed)" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round"
          filter="url(#shadow)"/>
  </svg>`;
}

/* Files Closed – Checkmark */
function svgFilesClosed() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradClosed" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#81C784"/>
        <stop offset="1" stop-color="#2E7D32"/>
      </linearGradient>
    </defs>
    <path d="M20 6L9 17l-5-5"
          stroke="url(#gradClosed)" stroke-width="2.2"
          stroke-linecap="round" stroke-linejoin="round"
          filter="url(#shadow)"/>
  </svg>`;
}

/* Files Pending – Hourglass */
function svgFilesPending() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradPending" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#EF9A9A"/>
        <stop offset="1" stop-color="#C62828"/>
      </linearGradient>
    </defs>
    <path d="M6 2h12M6 22h12M6 2l12 8-12 8 12 8-12-8z"
          stroke="url(#gradPending)" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round"
          filter="url(#shadow)"/>
  </svg>`;
}

/* Files Parked – Pause */
function svgFilesParked() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradParked" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#FFCC80"/>
        <stop offset="1" stop-color="#F57C00"/>
      </linearGradient>
    </defs>
    <path d="M9 5v14M15 5v14"
          stroke="url(#gradParked)" stroke-width="2.2"
          stroke-linecap="round"
          filter="url(#shadow)"/>
  </svg>`;
}

/* Average Processing Time – Clock */
function svgAvgProcessingTime() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradAvgTime" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#BA68C8"/>
        <stop offset="1" stop-color="#6A1B9A"/>
      </linearGradient>
    </defs>
    <circle cx="12" cy="12" r="9"
            stroke="url(#gradAvgTime)" stroke-width="1.8"
            filter="url(#shadow)"/>
    <path d="M12 8v4l2 2"
          stroke="url(#gradAvgTime)" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round"
          filter="url(#shadow)"/>
  </svg>`;
}

/* Median Processing Time – Median Lines */
function svgMedianProcessingTime() {
  return `<svg width="32" height="32" viewBox="0 0 24 24" fill="none">
    <defs>
      <linearGradient id="gradMedianTime" x1="0" y1="0" x2="24" y2="24">
        <stop stop-color="#4DB6AC"/>
        <stop offset="1" stop-color="#00695C"/>
      </linearGradient>
    </defs>
    <path d="M12 3v18"
          stroke="url(#gradMedianTime)" stroke-width="1.8"
          stroke-linecap="round"
          filter="url(#shadow)"/>
    <path d="M3 8h18M3 16h18"
          stroke="url(#gradMedianTime)" stroke-opacity="0.7"
          stroke-width="1.8" stroke-linecap="round"
          filter="url(#shadow)"/>
  </svg>`;
}


function setActiveOffice(o){
  activeOffice = o;
  [...subTabsContainer.querySelectorAll('.tab')].forEach(t=> t.classList.toggle('active', t.textContent===o));
  renderActiveView();
  renderCharts(); // <-- add this
}

/* initialize */
(async ()=>{
  try{
    const r = await fetch('employee_report_01.09.25.json',{cache:'no-store'});
    if(r.ok){
      const json = await r.json();
      if(Array.isArray(json)) loadData(json);
    }
  } catch(e){}
})();
</script>

</body>
</html>
